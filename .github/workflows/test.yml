name: Deploy
on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  get_env_matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.environments }}
    steps:
      - uses: actions/checkout@v4
      - id: matrix
        run: |
          env_list=$(curl --location https://api.github.com/repos/masashiyonekawa/containerapps-cicd-manifest/environments --header 'Authorization: Bearer ${{ secrets.GH_TOKEN }}' | jq -r '[.environments[].name]')
          echo environments=$(echo $env_list | jq -rc .) >> $GITHUB_OUTPUT

  do_process:
    runs-on: ubuntu-latest
    needs: get_env_matrix
    strategy:
      matrix:
        value: ${{ needs.get_env_matrix.outputs.matrix }}
    steps:
      - name: Processing for each environment
        run: |
          echo ${{ matrix.value }}
